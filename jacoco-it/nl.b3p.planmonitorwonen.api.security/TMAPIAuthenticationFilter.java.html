<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TMAPIAuthenticationFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Planmonitor Wonen API</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.planmonitorwonen.api.security</a> &gt; <span class="el_source">TMAPIAuthenticationFilter.java</span></div><h1>TMAPIAuthenticationFilter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2024 Provincie Zeeland
 *
 * SPDX-License-Identifier: MIT
 */
package nl.b3p.planmonitorwonen.api.security;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.ServletRequest;
import jakarta.servlet.ServletResponse;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.invoke.MethodHandles;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Objects;
import java.util.Set;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.ApplicationEventPublisherAware;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.AuthenticationDetailsSource;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.event.InteractiveAuthenticationSuccessEvent;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.context.SecurityContextHolderStrategy;
import org.springframework.security.web.WebAttributes;
import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
import org.springframework.security.web.context.SecurityContextRepository;
import org.springframework.security.web.util.matcher.RequestMatcher;
import org.springframework.util.Assert;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.filter.GenericFilterBean;

/**
 * An authentication filter that checks if the request has a valid session cookie from the TM API.
 */
<span class="nc" id="L56">public class TMAPIAuthenticationFilter extends GenericFilterBean</span>
    implements ApplicationEventPublisherAware {

<span class="nc" id="L59">  private static final Logger logger =</span>
<span class="nc" id="L60">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

<span class="nc" id="L62">  private ApplicationEventPublisher eventPublisher = null;</span>

<span class="nc" id="L64">  private final SecurityContextRepository securityContextRepository =</span>
      new HttpSessionSecurityContextRepository();

<span class="nc" id="L67">  private AuthenticationDetailsSource&lt;HttpServletRequest, ?&gt; authenticationDetailsSource =</span>
      new TMASPIAuthenticationDetailsSource();

<span class="nc" id="L70">  private AuthenticationManager authenticationManager = null;</span>

  @Value(&quot;${tailormap-api.credentials.url}&quot;)
  private String credentialsUrl;

  // TODO: implement cookie path
  //  @Value(&quot;${tailormap-api.cookie.path}&quot;)
  //  private String cookiePath;

  private RequestMatcher requiresAuthenticationRequestMatcher;
<span class="nc" id="L80">  private final SecurityContextHolderStrategy securityContextHolderStrategy =</span>
<span class="nc" id="L81">      SecurityContextHolder.getContextHolderStrategy();</span>

  public void setAuthenticationDetailsSource(
      AuthenticationDetailsSource&lt;HttpServletRequest, ?&gt; authenticationDetailsSource) {
<span class="nc" id="L85">    this.authenticationDetailsSource = authenticationDetailsSource;</span>
<span class="nc" id="L86">  }</span>

  public void setAuthenticationManager(AuthenticationManager authenticationManager) {
<span class="nc" id="L89">    this.authenticationManager = authenticationManager;</span>
<span class="nc" id="L90">  }</span>

  @Override
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
      throws IOException, ServletException {
<span class="nc bnc" id="L95" title="All 2 branches missed.">    if (this.requiresAuthenticationRequestMatcher.matches((HttpServletRequest) request)) {</span>
<span class="nc" id="L96">      logger.debug(</span>
<span class="nc" id="L97">          &quot;Authenticating {}&quot;, this.securityContextHolderStrategy.getContext().getAuthentication());</span>
<span class="nc" id="L98">      doAuthenticate((HttpServletRequest) request, (HttpServletResponse) response);</span>
    } else {
<span class="nc" id="L100">      logger.trace(</span>
          &quot;Did not authenticate since request did not match [{}]&quot;,
          this.requiresAuthenticationRequestMatcher);
    }
<span class="nc" id="L104">    chain.doFilter(request, response);</span>
<span class="nc" id="L105">  }</span>

  @Override
  public void afterPropertiesSet() {
    try {
<span class="nc" id="L110">      super.afterPropertiesSet();</span>
<span class="nc" id="L111">    } catch (ServletException ex) {</span>
<span class="nc" id="L112">      throw new RuntimeException(ex);</span>
<span class="nc" id="L113">    }</span>
<span class="nc" id="L114">    Assert.notNull(this.authenticationManager, &quot;An AuthenticationManager must be set&quot;);</span>
<span class="nc" id="L115">  }</span>

  private Object getPreAuthenticatedPrincipal(HttpServletRequest request) {
<span class="nc" id="L118">    logger.debug(&quot;requesting pre-authenticated principal for request: {}&quot;, request.getRequestURI());</span>

<span class="nc" id="L120">    Object principal = null;</span>
<span class="nc" id="L121">    final String sessionCookieValue = getSessionCookieValue(request);</span>
<span class="nc bnc" id="L122" title="All 4 branches missed.">    if (null == sessionCookieValue || sessionCookieValue.isBlank()) {</span>
<span class="nc" id="L123">      logger.debug(&quot;No session cookie found in request for {}.&quot;, request.getRequestURI());</span>
    } else {
      try {
<span class="nc" id="L126">        ObjectNode authResponse = getTMAPIAuthResponse(sessionCookieValue);</span>
<span class="nc" id="L127">        TMAPIAuthenticationToken token = getAuthenticatedPrincipal(authResponse);</span>
<span class="nc" id="L128">        request.setAttribute(&quot;authToken&quot;, token);</span>
<span class="nc" id="L129">        SecurityContextHolder.getContext().setAuthentication(token);</span>
<span class="nc" id="L130">        logger.debug(&quot;Returning principal from token: {}&quot;, token);</span>
<span class="nc" id="L131">        principal = token.getPrincipal();</span>
<span class="nc" id="L132">      } catch (JsonProcessingException e) {</span>
<span class="nc" id="L133">        throw new RuntimeException(e);</span>
<span class="nc" id="L134">      }</span>
    }
<span class="nc" id="L136">    return principal;</span>
  }

  public void setRequiresAuthenticationRequestMatcher(
      RequestMatcher requiresAuthenticationRequestMatcher) {
<span class="nc" id="L141">    Assert.notNull(requiresAuthenticationRequestMatcher, &quot;requestMatcher cannot be null&quot;);</span>
<span class="nc" id="L142">    this.requiresAuthenticationRequestMatcher = requiresAuthenticationRequestMatcher;</span>
<span class="nc" id="L143">  }</span>

  private String getSessionCookieValue(HttpServletRequest request) {
    // TODO in theory a request could have more than one JSESSIONID cookies for a url,
    //  so we would have to check all of them, for now just use the first one
    final Cookie jSessionId =
<span class="nc bnc" id="L149" title="All 2 branches missed.">        request.getCookies() == null</span>
<span class="nc" id="L150">            ? null</span>
<span class="nc" id="L151">            : Arrays.stream(request.getCookies())</span>
<span class="nc" id="L152">                .filter(cookie -&gt; &quot;JSESSIONID&quot;.equals(cookie.getName()))</span>
                // TODO filter cookie path for the TM API
                //  the current path is / though
                // .filter(cookie -&gt; cookiePath.equals(cookie.getPath()))
<span class="nc" id="L156">                .findFirst()</span>
<span class="nc" id="L157">                .orElse(null);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">    if (null == jSessionId) {</span>
<span class="nc" id="L160">      return null;</span>
    }

<span class="nc" id="L163">    logger.debug(</span>
<span class="nc" id="L164">        &quot;Found JSESSIONID = {} in request {}&quot;, jSessionId.getValue(), request.getRequestURI());</span>
<span class="nc" id="L165">    return jSessionId.getValue();</span>
  }

  private @NonNull ObjectNode getTMAPIAuthResponse(@NonNull String sessionCookieValue)
      throws JsonProcessingException {
<span class="nc" id="L170">    RestTemplate restTemplate = new RestTemplate();</span>
<span class="nc" id="L171">    HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L172">    headers.add(&quot;Cookie&quot;, &quot;JSESSIONID=%s&quot;.formatted(sessionCookieValue));</span>
<span class="nc" id="L173">    HttpEntity&lt;ObjectNode&gt; entity = new HttpEntity&lt;&gt;(headers);</span>
    // set up with default TM API unauthorized response
<span class="nc" id="L175">    ObjectNode authResponseBody =</span>
<span class="nc" id="L176">        (ObjectNode) new ObjectMapper().readTree(&quot;{\&quot;unauthorized\&quot;: true}&quot;);</span>

    try {
      // check with TM API if the user is authenticated with the session cookie value
<span class="nc" id="L180">      ResponseEntity&lt;ObjectNode&gt; authResponse =</span>
<span class="nc" id="L181">          restTemplate.exchange(credentialsUrl, HttpMethod.GET, entity, ObjectNode.class);</span>

<span class="nc bnc" id="L183" title="All 4 branches missed.">      if (authResponse.getStatusCode().is2xxSuccessful() &amp;&amp; null != authResponse.getBody()) {</span>
<span class="nc" id="L184">        authResponseBody = authResponse.getBody();</span>
<span class="nc" id="L185">        logger.trace(&quot;TM API response: {}&quot;, authResponseBody);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (!authResponse.getBody().get(&quot;isAuthenticated&quot;).asBoolean()) {</span>
<span class="nc" id="L187">          logger.warn(</span>
<span class="nc" id="L188">              &quot;User {} is not authenticated in TM API&quot;, authResponse.getBody().get(&quot;username&quot;));</span>
        } else {
<span class="nc bnc" id="L190" title="All 2 branches missed.">          if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L191">            logger.debug(&quot;User {} is authenticated&quot;, authResponse.getBody().get(&quot;username&quot;));</span>
<span class="nc" id="L192">            authResponse</span>
<span class="nc" id="L193">                .getBody()</span>
<span class="nc" id="L194">                .get(&quot;roles&quot;)</span>
<span class="nc" id="L195">                .forEach(role -&gt; logger.debug(&quot;Role from TM API: {}&quot;, role));</span>
          }
        }
      }

<span class="nc" id="L200">    } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L201">      logger.error(&quot;Error while authenticating user: {}&quot;, e.getMessage());</span>
<span class="nc" id="L202">    }</span>

<span class="nc" id="L204">    return authResponseBody;</span>
  }

  private @NonNull TMAPIAuthenticationToken getAuthenticatedPrincipal(
      @NonNull ObjectNode authResponse) {
<span class="nc" id="L209">    final Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;&gt;();</span>
<span class="nc" id="L210">    Objects.requireNonNull(authResponse)</span>
<span class="nc" id="L211">        .get(&quot;roles&quot;)</span>
<span class="nc" id="L212">        .forEach(</span>
            role -&gt; {
<span class="nc" id="L214">              authorities.add(new SimpleGrantedAuthority(role.asText()));</span>
<span class="nc" id="L215">            });</span>
<span class="nc" id="L216">    return new TMAPIAuthenticationToken(</span>
<span class="nc" id="L217">        authResponse.get(&quot;username&quot;).asText(), null, authorities, null, authResponse);</span>
  }

  @Override
  public void setApplicationEventPublisher(
      @NonNull ApplicationEventPublisher applicationEventPublisher) {
<span class="nc" id="L223">    this.eventPublisher = applicationEventPublisher;</span>
    try {
<span class="nc" id="L225">      super.afterPropertiesSet();</span>
<span class="nc" id="L226">    } catch (ServletException ex) {</span>
      // convert to RuntimeException for passivity on afterPropertiesSet signature
<span class="nc" id="L228">      throw new RuntimeException(ex);</span>
<span class="nc" id="L229">    }</span>
<span class="nc" id="L230">    Assert.notNull(this.authenticationManager, &quot;An AuthenticationManager must be set&quot;);</span>
<span class="nc" id="L231">  }</span>

  private void doAuthenticate(HttpServletRequest request, HttpServletResponse response)
      throws ServletException, IOException {
<span class="nc" id="L235">    Object principal = getPreAuthenticatedPrincipal(request);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">    if (principal == null) {</span>
<span class="nc" id="L237">      logger.debug(&quot;No pre-authenticated principal found in request&quot;);</span>
<span class="nc" id="L238">      return;</span>
    }
<span class="nc" id="L240">    logger.debug(&quot;pre-authenticated principal = {}, trying to authenticate&quot;, principal);</span>
    try {
<span class="nc" id="L242">      TMAPIAuthenticationToken authenticationRequest =</span>
<span class="nc" id="L243">          (TMAPIAuthenticationToken) request.getAttribute(&quot;authToken&quot;);</span>
<span class="nc" id="L244">      authenticationRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));</span>
<span class="nc" id="L245">      Authentication authenticationResult =</span>
<span class="nc" id="L246">          this.authenticationManager.authenticate(authenticationRequest);</span>
<span class="nc" id="L247">      successfulAuthentication(request, response, authenticationResult);</span>
<span class="nc" id="L248">    } catch (AuthenticationException ex) {</span>
<span class="nc" id="L249">      unsuccessfulAuthentication(request, response, ex);</span>
<span class="nc" id="L250">      throw ex;</span>
<span class="nc" id="L251">    }</span>
<span class="nc" id="L252">  }</span>

  protected void successfulAuthentication(
      HttpServletRequest request, HttpServletResponse response, Authentication authResult)
      throws IOException, ServletException {
<span class="nc" id="L257">    logger.debug(&quot;Authentication success: {}&quot;, authResult);</span>
<span class="nc" id="L258">    SecurityContext context = this.securityContextHolderStrategy.createEmptyContext();</span>
<span class="nc" id="L259">    context.setAuthentication(authResult);</span>
<span class="nc" id="L260">    this.securityContextHolderStrategy.setContext(context);</span>
<span class="nc" id="L261">    this.securityContextRepository.saveContext(context, request, response);</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">    if (this.eventPublisher != null) {</span>
<span class="nc" id="L264">      this.eventPublisher.publishEvent(</span>
<span class="nc" id="L265">          new InteractiveAuthenticationSuccessEvent(authResult, this.getClass()));</span>
    }
<span class="nc" id="L267">  }</span>

  protected void unsuccessfulAuthentication(
      HttpServletRequest request, HttpServletResponse response, AuthenticationException failed)
      throws IOException, ServletException {
<span class="nc" id="L272">    this.securityContextHolderStrategy.clearContext();</span>
<span class="nc" id="L273">    logger.debug(&quot;Cleared security context due to exception&quot;, failed);</span>
<span class="nc" id="L274">    request.setAttribute(WebAttributes.AUTHENTICATION_EXCEPTION, failed);</span>
    // TODO: implement failure handler
    //        if (this.authenticationFailureHandler != null) {
    //          this.authenticationFailureHandler.onAuthenticationFailure(request, response,
    // failed);
    //        }
<span class="nc" id="L280">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>